class i{constructor(){this.baseURL="/api",this.token=localStorage.getItem("auth_token"),this.currentChatId=null,this.user=JSON.parse(localStorage.getItem("user_data")||"{}")}async request(e,t={}){const s=`${this.baseURL}${e}`,a={headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${this.token}`,...t.headers},...t};try{const n=await fetch(s,a),c=await n.json();if(!n.ok)throw new Error(c.message||"An error occurred");return c}catch(n){throw console.error("API Error:",n),n}}async getChats(){return(await this.request("/chats")).data.chats}async getChat(e){return(await this.request(`/chats/${e}`)).data.chat}async createChat(e){return(await this.request("/chats",{method:"POST",body:JSON.stringify(e)})).data.chat}async getMessages(e,t=1){return(await this.request(`/messages/chat/${e}?page=${t}`)).data.messages}async sendMessage(e){return(await this.request("/messages",{method:"POST",body:JSON.stringify(e)})).data.message}async searchUsers(e){return(await this.request(`/users/search?query=${encodeURIComponent(e)}`)).data.users}async updateProfile(e){return(await this.request("/users/profile",{method:"PUT",body:JSON.stringify(e)})).data.user}}const r=new i;class d{constructor(){this.currentChatId=null,this.chats=[],this.messages=[],this.selectedUsers=[],this.init()}init(){this.loadUserData(),this.loadChats(),this.bindEvents(),this.setupWebSocket()}loadUserData(){const e=JSON.parse(localStorage.getItem("user_data")||"{}");e.id&&(document.getElementById("userName").textContent=e.full_name||e.username,e.profile_image_url&&(document.getElementById("userAvatarImg").src=e.profile_image_url))}async loadChats(){try{this.chats=await r.getChats(),this.renderChats()}catch(e){console.error("Error loading chats:",e)}}renderChats(){const e=document.getElementById("chatsList");if(e.innerHTML="",this.chats.length===0){e.innerHTML='<div class="no-chats">No chats yet. Start a new conversation!</div>';return}this.chats.forEach(t=>{const s=this.createChatElement(t);e.appendChild(s)})}createChatElement(e){const t=document.createElement("div");t.className="chat-item",t.dataset.chatId=e.id;const s=e.last_message,a=s?s.message_type==="text"?s.content:`ðŸ“Ž ${s.message_type}`:"No messages yet";return t.innerHTML=`
            <div class="chat-avatar">
                <img src="${e.image_url||"/images/default-avatar.png"}" alt="${e.name||"Chat"}">
            </div>
            <div class="chat-preview">
                <h4>${e.name||"Unknown Chat"}</h4>
                <p>${a}</p>
            </div>
            <div class="chat-time">
                ${s?this.formatTime(s.created_at):""}
            </div>
        `,t.addEventListener("click",()=>this.selectChat(e.id)),t}async selectChat(e){this.currentChatId=e,document.querySelectorAll(".chat-item").forEach(t=>{t.classList.remove("active")}),document.querySelector(`[data-chat-id="${e}"]`).classList.add("active"),document.getElementById("chatHeader").style.display="flex",document.getElementById("chatInputContainer").style.display="block",document.querySelector(".welcome-message").style.display="none",await this.loadChatDetails(e),await this.loadMessages(e)}async loadChatDetails(e){try{const t=await r.getChat(e);document.getElementById("chatName").textContent=t.name||"Chat",document.getElementById("chatStatus").textContent=`${t.members_count||0} members`,t.image_url&&(document.getElementById("chatAvatarImg").src=t.image_url)}catch(t){console.error("Error loading chat details:",t)}}async loadMessages(e){try{const t=await r.getMessages(e);this.messages=t.data,this.renderMessages()}catch(t){console.error("Error loading messages:",t)}}renderMessages(){const e=document.getElementById("chatMessages");e.innerHTML="",this.messages.forEach(t=>{const s=this.createMessageElement(t);e.appendChild(s)}),this.scrollToBottom()}createMessageElement(e){const t=document.createElement("div");t.className=`message ${e.sender_id===this.user.id?"own":""}`;const s=e.message_type==="text"?e.content:`ðŸ“Ž ${e.file_name||e.message_type}`;return t.innerHTML=`
            <div class="message-avatar">
                <img src="${e.sender.profile_image_url||"/images/default-avatar.png"}" alt="${e.sender.username}">
            </div>
            <div class="message-content">
                <p class="message-text">${s}</p>
                <div class="message-time">${this.formatTime(e.created_at)}</div>
            </div>
        `,t}async sendMessage(){const e=document.getElementById("messageInput"),t=e.value.trim();if(!(!t||!this.currentChatId))try{const s={chat_id:this.currentChatId,message_type:"text",content:t},a=await r.sendMessage(s);this.messages.push(a),this.renderMessages(),e.value=""}catch(s){console.error("Error sending message:",s)}}bindEvents(){document.getElementById("sendBtn").addEventListener("click",()=>this.sendMessage()),document.getElementById("messageInput").addEventListener("keypress",e=>{e.key==="Enter"&&this.sendMessage()}),document.getElementById("newChatBtn").addEventListener("click",()=>{document.getElementById("newChatModal").classList.add("show")}),document.getElementById("closeNewChatModal").addEventListener("click",()=>{document.getElementById("newChatModal").classList.remove("show")}),document.getElementById("cancelNewChat").addEventListener("click",()=>{document.getElementById("newChatModal").classList.remove("show")}),document.getElementById("chatType").addEventListener("change",e=>{const t=document.getElementById("chatNameGroup"),s=document.getElementById("chatDescriptionGroup");e.target.value==="private"?(t.style.display="none",s.style.display="none"):(t.style.display="block",s.style.display="block")}),document.getElementById("userSearch").addEventListener("input",async e=>{const t=e.target.value.trim();if(t.length<2){document.getElementById("usersList").innerHTML="";return}try{const s=await r.searchUsers(t);this.renderUserSearch(s)}catch(s){console.error("Error searching users:",s)}}),document.getElementById("createChat").addEventListener("click",()=>this.createNewChat()),document.getElementById("settingsBtn").addEventListener("click",()=>{confirm("Are you sure you want to logout?")&&this.logout()})}renderUserSearch(e){const t=document.getElementById("usersList");t.innerHTML="",e.forEach(s=>{const a=document.createElement("div");a.className="user-item",a.dataset.userId=s.id,a.innerHTML=`
                <div class="user-avatar">
                    <img src="${s.profile_image_url||"/images/default-avatar.png"}" alt="${s.username}">
                </div>
                <div>
                    <h4>${s.full_name||s.username}</h4>
                    <p>@${s.username}</p>
                </div>
            `,a.addEventListener("click",()=>this.toggleUserSelection(s.id,a)),t.appendChild(a)})}toggleUserSelection(e,t){this.selectedUsers.includes(e)?(this.selectedUsers=this.selectedUsers.filter(s=>s!==e),t.classList.remove("selected")):(this.selectedUsers.push(e),t.classList.add("selected"))}async createNewChat(){const e=document.getElementById("chatType").value,t=document.getElementById("chatName").value,s=document.getElementById("chatDescription").value;if(e!=="private"&&!t.trim()){alert("Please enter a chat name");return}if(this.selectedUsers.length===0){alert("Please select at least one user");return}try{const a={type:e,name:t,description:s,user_ids:this.selectedUsers},n=await r.createChat(a);this.chats.unshift(n),this.renderChats(),this.selectChat(n.id),document.getElementById("newChatModal").classList.remove("show"),this.resetNewChatForm()}catch(a){console.error("Error creating chat:",a),alert("Error creating chat: "+a.message)}}resetNewChatForm(){document.getElementById("newChatModal").querySelector("form").reset(),this.selectedUsers=[],document.getElementById("usersList").innerHTML="",document.querySelectorAll(".user-item").forEach(e=>{e.classList.remove("selected")})}setupWebSocket(){setInterval(()=>{this.currentChatId&&this.loadMessages(this.currentChatId)},5e3)}scrollToBottom(){const e=document.getElementById("chatMessages");e.scrollTop=e.scrollHeight}formatTime(e){const t=new Date(e),a=new Date-t;return a<6e4?"Just now":a<36e5?Math.floor(a/6e4)+"m ago":a<864e5?Math.floor(a/36e5)+"h ago":t.toLocaleDateString()}logout(){localStorage.removeItem("auth_token"),localStorage.removeItem("user_data"),window.location.href="/login"}}document.addEventListener("DOMContentLoaded",function(){window.location.pathname==="/chat"&&new d});
