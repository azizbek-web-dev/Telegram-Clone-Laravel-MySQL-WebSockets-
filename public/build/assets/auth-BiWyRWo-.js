class l{constructor(){this.baseURL="/api",this.token=localStorage.getItem("auth_token")}async request(e,o={}){const s=`${this.baseURL}${e}`,n={headers:{"Content-Type":"application/json",Accept:"application/json",...o.headers},...o};this.token&&(n.headers.Authorization=`Bearer ${this.token}`);try{const a=await fetch(s,n),u=await a.json();if(!a.ok)throw new Error(u.message||"An error occurred");return u}catch(a){throw console.error("API Error:",a),a}}async login(e){const o=await this.request("/auth/login",{method:"POST",body:JSON.stringify(e)});return o.success&&o.data.token&&(this.token=o.data.token,localStorage.setItem("auth_token",this.token),localStorage.setItem("user_data",JSON.stringify(o.data.user))),o}async register(e){return await this.request("/auth/register",{method:"POST",body:JSON.stringify(e)})}async logout(){try{await this.request("/auth/logout",{method:"POST"})}catch(e){console.error("Logout error:",e)}finally{this.token=null,localStorage.removeItem("auth_token"),localStorage.removeItem("user_data")}}async getCurrentUser(){return await this.request("/auth/me")}isAuthenticated(){return!!this.token}}const c=new l;document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("loginForm"),e=document.getElementById("registerForm");t&&t.addEventListener("submit",m),e&&e.addEventListener("submit",g),c.isAuthenticated()&&(window.location.href="/chat")});async function m(t){t.preventDefault();const e=t.target,o=e.querySelector('button[type="submit"]'),s=new FormData(e),n={email:s.get("email"),password:s.get("password"),device_type:s.get("device_type"),device_name:s.get("device_name")||navigator.userAgent};try{r(o,!0),d(),(await c.login(n)).success&&(i("Login successful! Redirecting...","success"),setTimeout(()=>{window.location.href="/chat"},1e3))}catch(a){i(a.message,"error")}finally{r(o,!1)}}async function g(t){t.preventDefault();const e=t.target,o=e.querySelector('button[type="submit"]'),s=new FormData(e),n={username:s.get("username"),email:s.get("email"),password:s.get("password"),password_confirmation:s.get("password_confirmation"),full_name:s.get("full_name"),phone:s.get("phone"),date_of_birth:s.get("date_of_birth")};try{r(o,!0),d(),(await c.register(n)).success&&(i("Registration successful! Please check your email for verification.","success"),setTimeout(()=>{window.location.href="/login"},2e3))}catch(a){i(a.message,"error")}finally{r(o,!1)}}function r(t,e){e?(t.disabled=!0,t.classList.add("loading"),t.textContent="Loading..."):(t.disabled=!1,t.classList.remove("loading"),t.textContent=t.getAttribute("data-original-text")||"Submit")}function i(t,e){d();const o=document.createElement("div");o.className=`${e}-message`,o.textContent=t;const s=document.querySelector(".auth-form");s.insertBefore(o,s.firstChild)}function d(){document.querySelectorAll(".error-message, .success-message").forEach(e=>e.remove())}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("password"),e=document.getElementById("password_confirmation");if(t&&e){let s=function(){t.value!==e.value?e.setCustomValidity("Passwords do not match"):e.setCustomValidity("")};var o=s;t.addEventListener("change",s),e.addEventListener("keyup",s)}});
